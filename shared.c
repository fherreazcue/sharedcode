refactored from shared
added some bits
No R* specific stuff!
